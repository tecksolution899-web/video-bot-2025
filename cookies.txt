import os
import yt_dlp
import threading
import http.server
import socketserver
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, filters, ContextTypes

# --- á‹«áŠ•á‰° áˆ˜áˆ¨áŒƒá‹á‰½ ---
TOKEN = '7665281312:AAFl3Q71Fz_-A90jDRXHkCkjMTLugAnS3BA'
CHANNEL_ID = -1003426701331
CHANNEL_URL = 'https://t.me/fast_video_save_bot'

# 1. Render Port Error áˆˆáˆ›áŒ¥á‹á‰µ (Health Check)
def run_health_check():
    port = int(os.environ.get("PORT", 8080))
    handler = http.server.SimpleHTTPRequestHandler
    with socketserver.TCPServer(("", port), handler) as httpd:
        print(f"Serving at port {port}")
        httpd.serve_forever()

async def check_membership(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    try:
        member = await context.bot.get_chat_member(chat_id=CHANNEL_ID, user_id=user_id)
        return member.status in ['member', 'administrator', 'creator']
    except Exception as e:
        print(f"Membership check error: {e}")
        return False

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("áŠ¥áŠ•áŠ³áŠ• áˆ˜áŒ¡! ğŸš€ á‰ªá‹²á‹® áˆˆáˆ›á‹áˆ¨á‹µ áˆ˜áŒ€áˆ˜áˆªá‹« á‰»áŠ“áˆ‹á‰½áŠ•áŠ• á‹­á‰€áˆ‹á‰€áˆ‰ áŠ¥áŠ“ á‹¨á‰ªá‹²á‹® áˆŠáŠ•áŠ­ á‹­áˆ‹áŠ©á¢")

async def download_video(update: Update, context: ContextTypes.DEFAULT_TYPE):
    is_member = await check_membership(update, context)
    if not is_member:
        keyboard = [[InlineKeyboardButton("á‰»áŠ“áˆ‰áŠ• á‰°á‰€áˆ‹á‰€áˆ âœ…", url=CHANNEL_URL)]]
        await update.message.reply_text("âš ï¸ áˆ˜áŒ€áˆ˜áˆªá‹« á‰»áŠ“áˆ‰áŠ• á‹­á‰€áˆ‹á‰€áˆ‰!", reply_markup=InlineKeyboardMarkup(keyboard))
        return

    url = update.message.text
    if "http" not in url:
        await update.message.reply_text("áŠ¥á‰£áŠ­á‹ á‰µáŠ­áŠ­áˆˆáŠ› áˆŠáŠ•áŠ­ á‹­áˆ‹áŠ©á¢")
        return

    status_msg = await update.message.reply_text("â³ á‰ªá‹²á‹®á‹ áŠ¥á‹¨á‰°á‹ˆáˆ¨á‹° áŠá‹... áŠ¥á‰£áŠ­á‹ á‹­áŒ á‰¥á‰á¢")
    file_name = f"{update.effective_user.id}.mp4"
    
    try:
        ydl_opts = {
            'format': 'best',
            'outtmpl': file_name,
            'cookiefile': 'cookies.txt', # á‹­áˆ… á‹á‹­áˆ GitHub áˆ‹á‹­ áˆ˜áŠ–áˆ©áŠ• áŠ áˆ¨áŒ‹áŒáŒ¥
            'noplaylist': True,
        }
        
        with yt_dlp.YoutubeDL(ydl_opts) as ydl:
            ydl.download([url])
        
        with open(file_name, 'rb') as video:
            await update.message.reply_video(video=video, caption="á‰ áˆµáŠ¬á‰µ á‹ˆáˆ­á‹·áˆ! âœ…")
        
        await status_msg.delete()
    except Exception as e:
        await update.message.reply_text(f"âŒ áˆµáˆ…á‰°á‰µá¦ {str(e)}")
    finally:
        if os.path.exists(file_name):
            os.remove(file_name)

if __name__ == '__main__':
    # Health check á‰ áˆŒáˆ‹ Thread áŠ¥áŠ•á‹²áŒ€áˆáˆ­
    threading.Thread(target=run_health_check, daemon=True).start()
    
    app = ApplicationBuilder().token(TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, download_video))
    
    print("ğŸš€ á‰¦á‰± áˆµáˆ« áŒ€áˆáˆ¯áˆ!")
    app.run_polling()
